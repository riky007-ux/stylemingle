name: Gate 11 Proof

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: "Preview BASE_URL to validate (e.g. https://...vercel.app)"
        required: true
        type: string
      vercel_protection_bypass:
        description: "Optional x-vercel-protection-bypass override"
        required: false
        type: string
      pr_number:
        description: "Optional PR number to post/update proof summary comment"
        required: false
        type: string

jobs:
  proof:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: write
    env:
      BASE_URL: ${{ inputs.base_url }}
      SMOKE_EMAIL: ${{ secrets.SMOKE_EMAIL }}
      SMOKE_PASSWORD: ${{ secrets.SMOKE_PASSWORD }}
      VERCEL_PROTECTION_BYPASS: ${{ inputs.vercel_protection_bypass != '' && inputs.vercel_protection_bypass || secrets.VERCEL_PROTECTION_BYPASS }}
      VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Validate required inputs/secrets
        run: |
          set -euo pipefail
          if [ -z "${BASE_URL:-}" ]; then
            echo "Missing required workflow input: base_url"
            exit 2
          fi
          if [ -z "${SMOKE_EMAIL:-}" ]; then
            echo "Missing required repository secret: SMOKE_EMAIL"
            exit 2
          fi
          if [ -z "${SMOKE_PASSWORD:-}" ]; then
            echo "Missing required repository secret: SMOKE_PASSWORD"
            exit 2
          fi

      - name: Prepare artifact directory
        run: mkdir -p .codex/artifacts/gate-11

      - name: Run Gate 11 proof
        id: gate11
        run: |
          set +e
          node .codex/gate-11-proof.mjs > .codex/artifacts/gate-11/ci-gate-11-proof.txt 2>&1
          code=$?
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          echo "EXIT_CODE=$code" >> .codex/artifacts/gate-11/ci-gate-11-proof.txt
          exit 0

      - name: Run Gate 10.2x smoke
        id: gate102x
        run: |
          set +e
          node .codex/gate-10.2x-smoke.mjs > .codex/artifacts/gate-11/ci-gate-10.2x-smoke.txt 2>&1
          code=$?
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          echo "EXIT_CODE=$code" >> .codex/artifacts/gate-11/ci-gate-10.2x-smoke.txt
          exit 0

      - name: Upload proof artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-11-proof-artifacts
          path: |
            .codex/artifacts/gate-11/ci-gate-11-proof.txt
            .codex/artifacts/gate-11/ci-gate-10.2x-smoke.txt

      - name: Write job summary
        if: always()
        run: |
          {
            echo "## Gate 11 Proof Summary"
            echo
            echo "- BASE_URL: ${BASE_URL}"
            echo "- gate-11-proof exit code: ${{ steps.gate11.outputs.exit_code }}"
            echo "- gate-10.2x-smoke exit code: ${{ steps.gate102x.outputs.exit_code }}"
            echo
            echo "### gate-11-proof.mjs"
            grep -E "^TOTAL:" .codex/artifacts/gate-11/ci-gate-11-proof.txt || tail -n 20 .codex/artifacts/gate-11/ci-gate-11-proof.txt
            echo
            echo "### gate-10.2x-smoke.mjs"
            grep -E "^TOTAL:" .codex/artifacts/gate-11/ci-gate-10.2x-smoke.txt || tail -n 20 .codex/artifacts/gate-11/ci-gate-10.2x-smoke.txt
            echo
            echo "> Reminder: verify Vercel runtime logs for expected endpoint signatures (/api/ai/wardrobe/tag, /api/ai/wardrobe/tag-batch, /api/ai/outfit, and upload pipeline endpoints)."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Post/update PR comment summary
        if: always() && inputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const prNumber = Number('${{ inputs.pr_number }}');
            if (!Number.isFinite(prNumber) || prNumber <= 0) {
              core.setFailed('Invalid pr_number input. Provide a numeric PR number.');
              return;
            }

            const gate11Path = '.codex/artifacts/gate-11/ci-gate-11-proof.txt';
            const smokePath = '.codex/artifacts/gate-11/ci-gate-10.2x-smoke.txt';
            const gate11 = fs.existsSync(gate11Path) ? fs.readFileSync(gate11Path, 'utf8') : '';
            const smoke = fs.existsSync(smokePath) ? fs.readFileSync(smokePath, 'utf8') : '';

            const findTotal = (text) => {
              const m = text.match(/^TOTAL:\s.*$/m);
              return m ? m[0] : 'TOTAL: unavailable';
            };

            const marker = '<!-- gate-11-proof-bot -->';
            const body = `${marker}\n## Gate 11 CI Proof Result\n\n- BASE_URL: ${{ inputs.base_url }}\n- gate-11-proof: ${'${{ steps.gate11.outputs.exit_code }}' === '0' ? 'PASS' : 'FAIL'} (exit ${'${{ steps.gate11.outputs.exit_code }}'})\n- gate-10.2x-smoke: ${'${{ steps.gate102x.outputs.exit_code }}' === '0' ? 'PASS' : 'FAIL'} (exit ${'${{ steps.gate102x.outputs.exit_code }}'})\n\n### Totals\n- gate-11-proof: ${findTotal(gate11)}\n- gate-10.2x-smoke: ${findTotal(smoke)}\n\nArtifacts: download \`gate-11-proof-artifacts\` from this workflow run.\n\nReminder: validate Vercel runtime log signatures for /api/ai/wardrobe/tag, /api/ai/wardrobe/tag-batch, /api/ai/outfit, and upload pipeline endpoints.`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100,
            });

            const existing = comments.find((c) => c.body && c.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
            }

      - name: Fail workflow if either proof script failed
        if: steps.gate11.outputs.exit_code != '0' || steps.gate102x.outputs.exit_code != '0'
        run: |
          echo "One or more proof scripts failed. See uploaded artifacts and job summary."
          exit 1
